---
title: "4. Population Genetics statistics"
author: "Giulio Caravagna"
date: "`r format(Sys.time(), '%d %B, %Y')`"
institute: "Institute for Cancer Research"
email: "giulio.caravagna@icr.ac.uk"
output: rmarkdown::github_document
vignette: >
  %\VignetteIndexEntry{4}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r, message=FALSE, warning=F}
library(mobster)
library(tidyr)
library(dplyr)
```

Population Genetics statistics can be extracted from a MOBSTER model. 

```{r}
data('fit_example', package = 'mobster')
print(fit_example$best)

evolutionary_parameters(fit_example)
```

The mutation rate `mu` (cell division units) scaled by the probability of lineage survival $\beta$, $\mu/\beta$, is given by:
\[
\mu/\beta = \dfrac{M} {(\frac{1}{f_\text{min}} - \frac{1}{f_\text{max}})}
\]
Where $f_\text{min}$ is the minimum VAF and $f_\text{max}$ is the maximum, and
$M$ is the number of mutations between $f_\text{min}$ and $f_\text{max}$.

Selection is defined as the relative growth rates of host tumor cell populations ($\lambda h$) vs subclone ($\lambda s$):
\[
1+s= \dfrac{\lambda h}{ \lambda s}
\]

The mathematical details of these computations are described in the main paper, and based on the population genetics model of tumour evolution in Williams et al. 2016 and 2018 (Nature Genetics).



```{r}
N_max = 10^9
s_posterior(fit_example,N_max,ncells = 2, u = 0, sigma = 0.5)
```

A posterior distribution of time of origin $t_{driver}$, time of mrca appearance t_{mrca} and selection coefficient s of a subclone.
We assume a Poisson distribution as likelihood for the number of diploid heterozygous mutations of the subclonal cluster with mean 
$M = 2\mu l\omega(t_{driver} + (1+s)(t_{mrca} - t_{driver}))$,where $l$ is the length of the diploid genome, 
$\mu$ is the mutation rate and $\omega$ is the growth rate of the tumour. 
We assume an exponential distribution as likelihood for the mean number of cells of the subclone. The rate of the exponential is the inverse of expected
subclone size $exp(-\omega*(T-t_{driver}))$, where $T$ is the time of sample collection. Times and growth rate are expressed in tumor doubling units. 
Posterior distributions are computed with HMC using RSTAN.


